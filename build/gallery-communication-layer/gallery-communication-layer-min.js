YUI.add("gallery-communication-layer",function(b){function a(c){NAME=NAME+": "+b.config.win.location.pathname;c=c||{};this._WIN=b.config.win;this._APPREADY="appready";this._BUFFER_TIMEOUT=c.bufferTimeout||10000;this._CALLBACK_TIMEOUT=c.callbackTimeout||10000;this._GUID=b.guid();this._proxyFor={};this._subscriptionFor={};this._PARENT_ORIGIN_ALIAS="parent";this._parentProxy=this._createEventProxy(this._PARENT_ORIGIN_ALIAS);if(c.debug){this._initDebugMode();}this._init();}a.prototype={_init:function(){this._initWindowMessageHandler();this._initParentConnection();},_initWindowMessageHandler:function(){this._addListener(this._WIN,"message",b.bind(function(h){var c,d,g;try{c=b.JSON.parse(h.data);}catch(f){}if(this._validateEventData(c)){g=this._createCLEventData(h,c);d=this._proxyRouter(h,c);if(d){d.fire(c.name,g);}}else{}},this));},_validateEventData:function(c){return !!(c&&c.name&&c.guid);},_proxyRouter:function(c,h){var f=h.name,e=h.guid,d=c.origin,g=null;if(this._proxyFor[f]){g=this._proxyFor[f];}else{if(this._proxyFor[e+d]){g=this._proxyFor[e+d];}else{}}return g;},_createCLEventData:function(c,d){var e={data:d.data,guid:d.guid,origin:c.origin,source:c.source};if(d.cbid){e.callback=b.bind(function(){this._postMessage(e.source,{name:d.cbid,guid:this._GUID,data:{args:b.Array(arguments)}},e.origin);},this);}return e;},_initParentConnection:function(){var d=this,f=d._WIN,c=f.location.href,e;if(f.parent==f){return;}if(c){e=d._getHandshakeToken(c);d._createEventProxy(e).once(e,function(g){d._deleteEventProxy(e);d._parentSource=g.source;d._parentOrigin=g.origin;d._parentGuid=g.guid;d._proxyFor[g.guid+g.origin]=d._parentProxy;d._parentProxy.fire(d._APPREADY);});d._postMessage(f.parent,{name:e,guid:d._GUID},"*");}},register:function(f,c){var d=this,g,e;f=b.one(f);g=f&&f.test("iframe")&&f.get("src");if(!g){return;}e=d._getHandshakeToken(g);d._createEventProxy(e).once(e,function(m){var h=m.origin,k=m.source,i=m.guid,j,l;if(b.Lang.isFunction(c)){j=d._createEventProxy(i+h);l=d._createCLProxy(j,{origin:h,source:k,guid:i});l.iframe=f;c(l);}d._deleteEventProxy(e);d._postMessage(k,{name:e,guid:d._GUID},h);});},_createCLProxy:function(f,h){var d=this,g=h.source,c=h.origin,e=h.guid;return{on:function(j,k){var i=b.Array(arguments);i.splice(1,1,function(l){if(c===l.origin){k(l);}});return f.on.apply(f,i);},once:function(j,k){var i=b.Array(arguments);i.splice(1,1,function(l){if(c===l.origin){k(l);}});return f.once.apply(f,i);},fire:function(j,k,i){d._fireWindowMessageEvent(j,g,c,{data:k,guid:e,callback:i});},open:function(j,i){return d._createConnectionObject(j,i,{guid:e,source:g,origin:c});},ready:function(i,j){return f.on(d._APPREADY,i,j);},purge:function(){b.Object.each(d._proxyFor,function(j,i){if(j===f){d._deleteEventProxy(i);}});f.detachAll();f=null;}};},ready:function(){this._fireParentMessageEvent(this._APPREADY);},on:function(d,e){var c=b.Array(arguments);c.unshift({once:false});return this._onParentMessageEvent.apply(this,c);},once:function(d,e){var c=b.Array(arguments);c.unshift({once:true});return this._onParentMessageEvent.apply(this,c);},fire:function(d,e,c){if(d){this._fireParentMessageEvent(d,e,c);}},open:function(d,c){if(this._parentAppIsReady()){return this._createConnectionObject(d,c,{guid:this._parentGuid,source:this._parentSource,origin:this._parentOrigin});}else{}},_createConnectionObject:function(f,c,h){var d=this,e,g;if(!(f&&b.Lang.isFunction(c)&&h.origin&&h.guid)){return null;}e=d._registerCallback(c,h.origin,h.guid,f);return{write:function(i){if(!d._subscriptionFor[f]){return;}d._fireWindowMessageEvent(f,h.source,h.origin,{data:i,guid:h.guid,callback:e});},close:function(){g=d._subscriptionFor[f];if(g){g.detach();delete d._subscriptionFor[f];}}};},_fireParentMessageEvent:function(e,h,c){var d=this,f,g;f=function(){d._fireWindowMessageEvent(e,d._parentSource,d._parentOrigin,{data:h,guid:d._parentGuid,callback:c});};if(!d._parentAppIsReady()){g=d._parentProxy.once(d._APPREADY,f);b.later(d._BUFFER_TIMEOUT,null,function(){if(!d._parentAppIsReady()){g.detach();}});}else{f();}},_parentAppIsReady:function(){var c=this._parentProxy.getEvent(this._APPREADY);return c.fired;},_getHandshakeToken:function(c){return c.replace(/[?].*$/,"").replace(/[#].*$/,"");},_registerCallback:function(f,k,i,d,j){var h=this._proxyFor[i+k],g=b.stamp(f),e,c;if(!h){return;}if(j){c=h.once(g,function(l){e.cancel();f.apply(null,l.data.args);});e=b.later(j,null,function(){c.detach();});}else{this._subscriptionFor[d]=h.on(g,function(l){f.apply(null,l.data.args);});}return g;},_createEventProxy:function(d){if(d){var c=new b.EventTarget();c.publish(this._APPREADY,{fireOnce:true});this._proxyFor[d]=c;return c;}},_deleteEventProxy:function(c){if(this._proxyFor[c]){this._proxyFor[c].detachAll();this._proxyFor[c]=null;}},_onParentMessageEvent:function(){var d=b.Array(arguments),c=d.shift(),f=c.once?"once":"on",e=this._parentProxy;return e[f].apply(e,d);},_fireWindowMessageEvent:function(e,f,d,h){var g,c;if(e&&f&&d){h=h||{};c=h.callback;g={name:e,guid:this._GUID};if(h.data){g.data=h.data;}if(b.Lang.isFunction(c)){g.cbid=this._registerCallback(c,d,h.guid,e,this._CALLBACK_TIMEOUT);}else{if(b.Lang.isString(c)){g.cbid=c;}}this._postMessage(f,g,d);}},_postMessage:function(d,e,c){if(d&&d.postMessage&&e&&c){d.postMessage(b.JSON.stringify(e),c);return true;}},_initDebugMode:function(){var c=this,d=c._createEventProxy("debug");YUI.CL={fire:function(e,f){d.fire(e,{data:f});},on:function(){return d.on.apply(d,arguments);},once:function(){return d.once.apply(d,arguments);}};b.Array.each(["fire","on","once"],function(e){var f=c[e];c[e]=function(){var g=b.Array(arguments);d[e].apply(d,g);f.apply(c,g);};});},_addListener:function(d,e,c){if(d.addEventListener){d.addEventListener(e,c,false);}else{if(d.attachEvent){d.attachEvent("on"+e,c);}else{d["on"+e]=c;}}},_removeListener:function(e,f,d){if(e.removeEventListener){try{e.removeEventListener(f,d);}catch(c){}}else{if(e&&e.detachEvent){e.detachEvent("on"+f,d);}}}};b.CommunicationLayer=a;},"gallery-2012.06.27-20-10",{requires:["json","node-base","event-custom-base"],skinnable:false});
